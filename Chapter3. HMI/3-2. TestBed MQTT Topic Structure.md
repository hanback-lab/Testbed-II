# TestBed MQTT Topic Structure 
TestBed의 모든 장치는 MQTT를 통해 같은 규칙의 토픽으로 통신합니다. 토픽은 정해진 규칙에 따라 구성되며, 한 줄의 토픽 문자열 안에 **“어느 장비에서, 어느 공간에서, 어떤 장치를, 무엇(제어/상태)으로 다루는지”** 가 모두 포함됩니다.

이 구조를 쓰면 장치 수가 늘어나도 규칙이 흔들리지 않고, + 와일드카드로 구역 전체 구독(ROOM의 모든 STATE) 또는 특정 장치만 구독(ENTRANCE의 DOORLOCK) 같은 구독 패턴을 쉽게 만들 수 있습니다.
또한 TestBed는 단순히 “누가 publish하느냐”를 정하는 수준을 넘어서, 제어 명령 흐름을 단계적으로 분리합니다. 

사용자는 PC에서 SET으로 “요청”만 하고, HMI는 이를 받아 정책/권한/충돌 처리를 수행한 뒤 Auto Controller에 ACT로 “실행 명령”을 전달합니다.

Auto Controller는 실제 하드웨어를 제어한 결과와 센서 데이터를 STATE로 발행하여, PC/HMI가 같은 방식으로 모니터링할 수 있게 합니다.

즉, SET → ACT → STATE는 “요청–중재–실행–피드백”의 파이프라인이며, 여러 사용자가 동시에 접속하는 환경에서도 충돌 방지, 로깅/추적, 보안(익명 허용 범위 제한), 확장성을 확보하기 위한 구조입니다.

마지막으로 AVAILABILITY 토픽은 Auto Controller의 온라인/오프라인 상태를 제공하여, HMI가 장치 연결 상태를 빠르게 판단하고 장애 상황을 사용자에게 안내할 수 있도록 돕습니다.

<img src="res/device connection.png" width=100%>

## TestBed MQTT 토픽 
TestBed의 토픽은 미리 정의 되어 있으며, 정의된 토픽을 꼭 활용해야 합니다. 기본적인 토픽 구조는 다음과 같습니다. 

>- TestBed 토픽 구조 
>    - TB/{UNIQUE_NUM}/{TESTBED_PLACE}/{DEVICE_NAME}/{DEVICE_PARAM}
>        - {UNIQUE_NUM} : 장비의 고유 번호 
>            - 학교 혹은 시설 고유 문자 + 장치 번호 
>                - ex) HBE01, HBE02 ... 
>        - {TESTBED_PLACE} : TestBed 의 내부 구역 
>            - 지정된 문자 사용 : ENTRANCE, ROOM, KITCHEN, PIXBOARD 
>        - {DEVICE_NAME} : 장치 이름 
>            - LAMP, FAN, LIGHT... 
>        - {DEVICE_PARAM} : 장치의 제어 및 피드백 

토픽의 기본 구조는 앞의 설명과 같이 장비의 고유 식별자와 장비 내부 구역정보, 장치의 이름, 제어 명령 혹은 상태가 포함됩니다. 이를 세분화 하면 TestBed에서 MQTT 통신을 활용하는 3가지 기기(PC, HMI, Auto제어기)에서 활용 하는 정보가 각각 다르며, 사용자에 따른 토픽 구독 가능 여부도 구분되어 있습니다. 

우선 3가지 기기에서 활용하는 토픽을 구분해 보겠습니다. 

## 기기에 따른 토픽 구분 
>- PC Topic 
>    - Publish Topic List
>        - TB/+/+/+/SET : HMI에 장치 제어 요청 토픽, 익명 사용자를 허용 
>            - ex) TB/HBE01/ENTRANCE/DOORLOCK/SET
>    - Subscribe Topic List 
>        - TB/+/+/+/STATE : 장치의 상태 혹은 센서의 정보 토픽을 구독 
>            - ex) TB/HBE01/KITCHEN/LIGHT/STATE

>- HMI Topic 
>    - Publish Topic List
>        - TB/+/+/+/ACT : Auto 제어기에 장치 제어 요청 토픽, 익명 사용자를 허용하지 않음
>            - ex) TB/HBE01/ENTRANCE/DOORLOCK/ACT
>    - Subscribe Topic List 
>        - TB/+/+/+/SET : PC에서 발행한 장치 제어 요청 토픽 
>            - ex) TB/HBE01/ROOM/FAN/SET
>        - TB/+/+/AVAILABILITY : Auto 제어기의 연결 상태 토픽 
>            - ex) TB/HBE01/ROOM/AVAILABILITY

>- Auto 제어기 
>    - Publish Topic List
>        - TB/+/+/+/STATE : 장치 제어 결과 혹은 센서 데이터 토픽, 익명 사용자를 허용
>        - TB/+/+/AVAILABILITY : Auto 제어기의 연결 상태 토픽 
>    - Subscribe Topic List 
>        - TB/+/+/+/ACT : HMI에서 발행한 장치 제어 요청 토픽을 구독 

## 구역에 따른 상세 토픽 
TestBed 구역에 따른 토픽을 구분하면 다음과 같이 구분할 수 있습니다. 

### 현관 토픽 정보 
- {TOPIC_HEAD} : TB/{UNIQUE_NUM}/ENTRANCE
- Sensor list 
    - TPHG  
        - STATE Topic : {TOPIC_HEAD}/TPHG/STATE
            - `Publisher : Entrance Auto Controller`
            - Pub Interval : 1sec
            - Type : JSON
            - Key List
                - ts : Time Stamp 
                - temp : Temperature 
                - humi : Humidity
                - press : Pressure 
                - gas : Gas Resistance
            - ex) `{"ts":1609460954, "temp":23.1, "humi":45.2, "press":1005.2, "gas":320}`
    - Light 
        - STATE Topic : {TOPIC_HEAD}/LIGHT/STATE
            - `Publisher : Entrance Auto Controller`
            - Pub Interval : 1sec
            - Type : JSON
            - Key List 
                - ts : Time Stamp 
                - state : Light Sensor Data 
            - ex) `{"ts":1609460954, "state":324}`
    - Switch 
        - STATE Topic : {TOPIC_HEAD}/SWITCH/STATE
            - `Publisher : Entrance Auto Controller`
            - Pub Interval : When an interrupt occurs(Push or Pull), Debounce Time 50ms 
            - Type : JSON
            - Key List 
                - ts : Time Stamp 
                - state : 0 or 1 
            - ex) `{"ts":1609460954, "state":0}`
    - Impact 
        - STATE Topic : {TOPIC_HEAD}/IMPACT/STATE
            - `Publisher : Entrance Auto Controller`
            - Pub Interval : When shock is detected or 5sec, Detect Hold Time 1200ms 
            - Type : JSON 
            - Key List 
                - ts : Time Stamp
                - state : "detect" or "none"
            - ex) `{"ts":1609460954, "state":"detect"}` 
    - Pir 
        - STATE Topic : {TOPIC_HEAD}/PIR/STATE
            - `Publisher : Entrance Auto Controller`
            - Pub Interval : When an interrupt occurs(Push or Pull), Lockout Time 100ms
            - Type : JSON 
            - Key List 
                - ts : Time Stamp
                - state : "detect" or "none"
            - ex) `{"ts":1609460954, "state":"detect"}` 
- Actuator list
    - Lamp 
        - SET Topic : {TOPIC_HEAD}/LAMP/SET
            - `Publisher : PC`
        - ACT Topic : {TOPIC_HEAD}/LAMP/ACT
            - `Publisher : HMI`
        - STATE Topic : {TOPIC_HEAD}/LAMP/STATE
            - `Publisher : Entrance Auto Controller`
        - TYPE : JSON 
        - Key List
            - ts : Time Stamp 
            - state : "on" or "off" 
        - ex) `{"ts":1609460954, "state":"on"}` 
    - DoorLock
        - SET Topic : {TOPIC_HEAD}/DOORLOCK/SET
                - `Publisher : PC`
            - ACT Topic : {TOPIC_HEAD}/DOORLOCK/ACT
                - `Publisher : HMI`
            - STATE Topic : {TOPIC_HEAD}/DOORLOCK/STATE
                - `Publisher : Entrance Auto Controller`
            - TYPE : JSON 
            - Key List
                - ts : Time Stamp 
                - state : "open" or "close" 
            - ex) `{"ts":1609460954, "state":"open"}` 
    - LED
        - SET Topic : {TOPIC_HEAD}/LED/SET
                - `Publisher : PC`
            - ACT Topic : {TOPIC_HEAD}/LED/ACT
                - `Publisher : HMI`
            - STATE Topic : {TOPIC_HEAD}/LED/STATE
                - `Publisher : Entrance Auto Controller`
            - TYPE : JSON 
            - Key List
                - ts : Time Stamp 
                - state : "RED" or "GREEN" or "BLUE"
            - ex) `{"ts":1609460954, "state":"RED"}` 

### 방 토픽 정보 
- {TOPIC_HEAD} : TB/{UNIQUE_NUM}/ROOM
- Sensor list 
    - TPHG  
        - STATE Topic : {TOPIC_HEAD}/TPHG/STATE
            - `Publisher : Room Auto Controller`
            - Pub Interval : 1sec
            - Type : JSON
            - Key List
                - ts : Time Stamp 
                - temp : Temperature 
                - humi : Humidity
                - press : Pressure 
                - gas : Gas Resistance
            - ex) `{"ts":1609460954, "temp":23.1, "humi":45.2, "press":1005.2, "gas":320}`
    - Light 
        - STATE Topic : {TOPIC_HEAD}/LIGHT/STATE
            - `Publisher : Room Auto Controller`
            - Pub Interval : 1sec
            - Type : JSON
            - Key List 
                - ts : Time Stamp 
                - state : Light Sensor Data 
            - ex) `{"ts":1609460954, "state":324}`
    - Switch 
        - STATE Topic : {TOPIC_HEAD}/SWITCH/STATE
            - `Publisher : Room Auto Controller`
            - Pub Interval : When an interrupt occurs(Push or Pull), Debounce Time 50ms 
            - Type : JSON
            - Key List 
                - ts : Time Stamp 
                - state : 0 or 1 
            - ex) `{"ts":1609460954, "state":0}`
    - Impact 
        - STATE Topic : {TOPIC_HEAD}/IMPACT/STATE
            - `Publisher : Room Auto Controller`
            - Pub Interval : When shock is detected or 5sec, Detect Hold Time 1200ms 
            - Type : JSON 
            - Key List 
                - ts : Time Stamp
                - state : "detect" or "none"
            - ex) `{"ts":1609460954, "state":"detect"}` 
    - Dust 
        - STATE Topic : {TOPIC_HEAD}/DUST/STATE
            - `Publisher : Room Auto Controller`
            - Pub Interval : 1sec
            - Type : JSON 
            - Key List 
                - ts : Time Stamp
                - pm1_0 : TSI 1.0
                - pm2_5 : TSI 2.5 
                - pm10 : TSI 10 
            - ex) `{"ts":1609460954, "pm1_0":12, "pm2_5":12, "pm10":12}` 
- Actuator list
    - Lamp 
        - SET Topic : {TOPIC_HEAD}/LAMP/SET
            - `Publisher : PC`
        - ACT Topic : {TOPIC_HEAD}/LAMP/ACT
            - `Publisher : HMI`
        - STATE Topic : {TOPIC_HEAD}/LAMP/STATE
            - `Publisher : Room Auto Controller`
        - TYPE : JSON 
        - Key List
            - ts : Time Stamp 
            - state : "on" or "off" 
        - ex) `{"ts":1609460954, "state":"on"}` 
    - Fan 
        - SET Topic : {TOPIC_HEAD}/FAN/SET
            - `Publisher : PC`
        - ACT Topic : {TOPIC_HEAD}/FAN/ACT
            - `Publisher : HMI`
        - STATE Topic : {TOPIC_HEAD}/FAN/STATE
            - `Publisher : Room Auto Controller`
        - TYPE : JSON 
        - Key List
            - ts : Time Stamp 
            - state : "on" or "off" 
        - ex) `{"ts":1609460954, "state":"on"}`
    - Curtain
        - SET Topic : {TOPIC_HEAD}/CURTAIN/SET
                - `Publisher : PC`
            - ACT Topic : {TOPIC_HEAD}/CURTAIN/ACT
                - `Publisher : HMI`
            - STATE Topic : {TOPIC_HEAD}/CURTAIN/STATE
                - `Publisher : Room Auto Controller`
            - TYPE : JSON 
            - Key List
                - ts : Time Stamp 
                - state  
                    - SET & ACT : "open" or "close" or "stop" 
                    - STATE : "OPENED" or "OPENING" or "CLOSED" or "CLOSING" or "STOP"
            - ex) `{"ts":1609460954, "state":"CLOSING"}` 
    - LED
        - SET Topic : {TOPIC_HEAD}/LED/SET
                - `Publisher : PC`
            - ACT Topic : {TOPIC_HEAD}/LED/ACT
                - `Publisher : HMI`
            - STATE Topic : {TOPIC_HEAD}/LED/STATE
                - `Publisher : Room Auto Controller`
            - TYPE : JSON 
            - Key List
                - ts : Time Stamp 
                - state : "RED" or "GREEN" or "BLUE"
            - ex) `{"ts":1609460954, "state":"RED"}` 

### 주방 토픽 정보 
- {TOPIC_HEAD} : TB/{UNIQUE_NUM}/KITCHEN
- Sensor list 
    - TPHG  
        - STATE Topic : {TOPIC_HEAD}/TPHG/STATE
            - `Publisher : Kitchen Auto Controller`
            - Pub Interval : 1sec
            - Type : JSON
            - Key List
                - ts : Time Stamp 
                - temp : Temperature 
                - humi : Humidity
                - press : Pressure 
                - gas : Gas Resistance
            - ex) `{"ts":1609460954, "temp":23.1, "humi":45.2, "press":1005.2, "gas":320}`
    - Light 
        - STATE Topic : {TOPIC_HEAD}/LIGHT/STATE
            - `Publisher : Kitchen Auto Controller`
            - Pub Interval : 1sec
            - Type : JSON
            - Key List 
                - ts : Time Stamp 
                - state : Light Sensor Data 
            - ex) `{"ts":1609460954, "state":324}`
    - Switch 
        - STATE Topic : {TOPIC_HEAD}/SWITCH/STATE
            - `Publisher : Kitchen Auto Controller`
            - Pub Interval : When an interrupt occurs(Push or Pull), Debounce Time 50ms 
            - Type : JSON
            - Key List 
                - ts : Time Stamp 
                - state : 0 or 1 
            - ex) `{"ts":1609460954, "state":0}`
    - Impact 
        - STATE Topic : {TOPIC_HEAD}/IMPACT/STATE
            - `Publisher : Kitchen Auto Controller`
            - Pub Interval : When shock is detected or 5sec, Detect Hold Time 1200ms 
            - Type : JSON 
            - Key List 
                - ts : Time Stamp
                - state : "detect" or "none"
            - ex) `{"ts":1609460954, "state":"detect"}` 
    - GasDetector 
        - STATE Topic : {TOPIC_HEAD}/GASDETECTOR/STATE
            - `Publisher : Kitchen Auto Controller`
            - Pub Interval : When Gas is detected
            - Type : JSON 
            - Key List 
                - ts : Time Stamp
                - state : "detect" or "none"
            - ex) `{"ts":1609460954, "state":"none"}` 
- Actuator list
    - Lamp 
        - SET Topic : {TOPIC_HEAD}/LAMP/SET
            - `Publisher : PC`
        - ACT Topic : {TOPIC_HEAD}/LAMP/ACT
            - `Publisher : HMI`
        - STATE Topic : {TOPIC_HEAD}/LAMP/STATE
            - `Publisher : Kitchen Auto Controller`
        - TYPE : JSON 
        - Key List
            - ts : Time Stamp 
            - state : "on" or "off" 
        - ex) `{"ts":1609460954, "state":"on"}` 
    - Fan 
        - SET Topic : {TOPIC_HEAD}/FAN/SET
            - `Publisher : PC`
        - ACT Topic : {TOPIC_HEAD}/FAN/ACT
            - `Publisher : HMI`
        - STATE Topic : {TOPIC_HEAD}/FAN/STATE
            - `Publisher : Kitchen Auto Controller`
        - TYPE : JSON 
        - Key List
            - ts : Time Stamp 
            - state : "on" or "off" 
        - ex) `{"ts":1609460954, "state":"on"}`
    - GasBreaker
        - SET Topic : {TOPIC_HEAD}/GASBREAKER/SET
                - `Publisher : PC`
            - ACT Topic : {TOPIC_HEAD}/GASBREAKER/ACT
                - `Publisher : HMI`
            - STATE Topic : {TOPIC_HEAD}/GASBREAKER/STATE
                - `Publisher : Kitchen Auto Controller`
            - TYPE : JSON 
            - Key List
                - ts : Time Stamp 
                - state : "open" or "close"
            - ex) `{"ts":1609460954, "state":"close"}` 
    - LED
        - SET Topic : {TOPIC_HEAD}/LED/SET
                - `Publisher : PC`
            - ACT Topic : {TOPIC_HEAD}/LED/ACT
                - `Publisher : HMI`
            - STATE Topic : {TOPIC_HEAD}/LED/STATE
                - `Publisher : Kitchen Auto Controller`
            - TYPE : JSON 
            - Key List
                - ts : Time Stamp 
                - state : "RED" or "GREEN" or "BLUE"
            - ex) `{"ts":1609460954, "state":"RED"}` 

### PIXBOARD 토픽정보 
- {TOPIC_HEAD} : TB/{UNIQUE_NUM}/PIXBOARD
- Actuator list
    - Text Input
        - SET Topic : {TOPIC_HEAD}/TEXT/SET
            - `Publisher : PC`
        - ACT Topic : {TOPIC_HEAD}/TEXT/ACT
            - `Publisher : HMI`
        - Key List
            - ts : Time Stamp 
            - text : str
        - ex) `{"ts":1609460954, "text":"Hello World"}` 
    - Text Shift
        - SET Topic : {TOPIC_HEAD}/SHIFT/SET
            - `Publisher : PC`
        - ACT Topic : {TOPIC_HEAD}/SHIFT/ACT
            - `Publisher : HMI`
        - Key List
            - ts : Time Stamp 
            - shift_dir : "left" or "right" or "up" or "down" or "off"
            - shift_speed : 0~9
        - ex) `{"ts":1609460954, "shift_dir":"left", "shift_speed":0}` 
    - Text Color
        - SET Topic : {TOPIC_HEAD}/TEXT_COLOR/SET
            - `Publisher : PC`
        - ACT Topic : {TOPIC_HEAD}/TEXT_COLOR/ACT
            - `Publisher : HMI`
        - Key List
            - ts : Time Stamp 
            - color : [RED,GREEN,BLUE]
        - ex) `{"ts":1609460954, "color":[25,0,38]}` 
    - Background Color
        - SET Topic : {TOPIC_HEAD}/BG_COLOR/SET
            - `Publisher : PC`
        - ACT Topic : {TOPIC_HEAD}/BG_COLOR/ACT
            - `Publisher : HMI`
        - Key List
            - ts : Time Stamp 
            - color : [RED,GREEN,BLUE]
        - ex) `{"ts":1609460954, "color":[25,0,38]}` 


## 토픽 구독을 활용한 TPHG 센서 데이터 수신 
센서는 외부로부터 제어 명령을 받지 않으며, 자신이 측정한 값을 주기적으로 MQTT 토픽으로 발행(Publish)합니다. STATE 토픽을 구독(Subscribe)함으로써 센서 데이터를 실시간으로 모니터링할 수 있습니다.

아래 예제는 ROOM에 설치된 TPHG 센서의 상태 토픽을 구독합니다.

```python
import json
import paho.mqtt.client as mqtt

BROKER = "YOUR BROKER IP"
TOPIC = "TB/HBE01/ROOM/TPHG/STATE"

def on_message(client, userdata, msg):
    data = json.loads(msg.payload.decode())
    print(f"[TPHG] Temp:{data['temp']}°C  Humi:{data['humi']}%  Pressure:{data['press']}  Gas:{data['gas']}")

client = mqtt.Client()
client.on_message = on_message

client.connect(BROKER)
client.subscribe(TOPIC)
client.loop_forever()
```

## 토픽 발행을 활용한 Lamp 제어 
TestBed에서는 사용자가 직접 하드웨어를 제어하지 않습니다. 사용자는 단지 “요청(SET)” 을 보내고, HMI가 이를 받아 정책·권한·충돌 처리 후 Auto Controller에게 “실행 명령(ACT)” 을 전달합니다.

다음 예제는 ROOM 의 Lamp 를 제어하는 예시입니다. 

```python
import json
import paho.mqtt.client as mqtt
import time

BROKER = "YOUR BROKER IP"
TOPIC = "TB/HBE01/ROOM/LAMP/SET"

client = mqtt.Client()
client.connect(BROKER)

payload = {"ts": time.time(),"state": "on"}

client.publish(TOPIC, json.dumps(payload))
time.sleep(1)
payload = {"ts": time.time(),"state": "off"}
client.publish(TOPIC, json.dumps(payload))
client.disconnect()
```

## 구독/발행을 활용한 자동 제어 
센서의 STATE 토픽을 활용하여 센서데이터를 주기적으로 수신할 수 있다면, STATE에 전달된 데이터를 기반으로 액츄에이터 자동 제어가 가능합니다. 다음 예제는 Light 센서의 값을 기준으로 Lamp 를 제어하는 예제 입니다. 센서데이터가 수신될때마다, 기준값과 비교하여 기준보다 크면 Lamp를 끄고, 작으면 켜는 요청을 발행합니다. 자동 제어 기준은 실습 환경에 따라 상이함으로 환경에 맞춰 수정하여 테스트를 진행해 보시기 바랍니다. 

```python 
import json
import time
import paho.mqtt.client as mqtt

BROKER = "YOUR BROKER IP"
LIGHT_TOPIC = "TB/HBE01/KITCHEN/LIGHT/STATE"
LAMP_SET_TOPIC = "TB/HBE01/KITCHEN/LAMP/SET"

def on_message(client, userdata, msg):
    data = json.loads(msg.payload.decode())
    light_value = data["state"]

    if light_value < 200:
        cmd = "on"
    else:
        cmd = "off"

    payload = {
        "ts": time.time(),
        "state": cmd
    }

    client.publish(LAMP_SET_TOPIC, json.dumps(payload))

client = mqtt.Client()
client.on_message = on_message

client.connect(BROKER)
client.subscribe(LIGHT_TOPIC)
client.loop_forever()
```

## 구독/발행을 활용한 자동 제어 심화 
MQTT on_message() 콜백에서 제어 로직까지 처리하면 구현은 간단하지만, 콜백 안에서 발행까지 수행할 경우 블로킹/지연, 중복 발행, 복잡한 정책 추가가 어려워질 수 있습니다. 따라서 조금 더 유연한 설계를 위해서는 콜백에서는 최소한의 기능을 구현하고, 실제 장치제어 혹은 외부 통신 등의 작업들은 별도의 스레드에서 처리하는 것이 더 효율적입니다. 

다음은 앞서 작성한 예제와 동작 기능은 동일하지만 동작 구조가 다르게 설계된 프로그램입니다. 콜백에서는 수신된 센서데이터 값만 저장하고, 메인 루프가 주기적으로 값을 확인하여 상태 변화가 있을 때에만 SET을 발행하여 불필요한 토픽 발행도 줄인 프로그램입니다. 

```python
import json
import time
import threading
import paho.mqtt.client as mqtt

BROKER = "YOUR BROKER IP"

LIGHT_TOPIC = "TB/HBE01/KITCHEN/LIGHT/STATE"
LAMP_SET_TOPIC = "TB/HBE01/KITCHEN/LAMP/SET"

THRESHOLD = 200

latest_light = None
latest_ts = None
lock = threading.Lock()

def on_message(client, userdata, msg):
    global latest_light, latest_ts
    try:
        data = json.loads(msg.payload.decode())
        light_value = int(data.get("state", 0))
        ts = float(data.get("ts", time.time()))
        with lock:
            latest_light = light_value
            latest_ts = ts
    except Exception:
        return

def desired_lamp_state(light_value: int) -> str:
    return "on" if light_value < THRESHOLD else "off"

def main():
    client = mqtt.Client(client_id="pc-auto-light-loop")
    client.on_message = on_message
    client.connect(BROKER)

    client.subscribe(LIGHT_TOPIC)
    client.loop_start()

    last_sent = None
    last_seen_sensor_time = 0.0

    try:
        while True:
            with lock:
                light = latest_light
                ts = latest_ts

            if light is None:
                time.sleep(0.1)
                continue

            if ts is not None and ts == last_seen_sensor_time:
                time.sleep(0.1)
                continue
            if ts is not None:
                last_seen_sensor_time = ts

            desired = desired_lamp_state(light)
            if desired != last_sent:
                payload = {"ts": time.time(), "state": desired}
                client.publish(LAMP_SET_TOPIC, json.dumps(payload))
                last_sent = desired
                print(f"[AUTO] light={light} -> LAMP/SET {desired}")

            time.sleep(0.05)

    except KeyboardInterrupt:
        pass
    finally:
        client.loop_stop()
        client.disconnect()

if __name__ == "__main__":
    main()
```